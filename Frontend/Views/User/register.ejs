<% layout("../Layouts/boilerplate") %>

    <div class="signup-page">

        <!-- Notification Container -->
        <div class="notification-container" id="notificationContainer"></div>

        <div class="signup-container">
            <!-- Desktop Decorative Elements -->
            <div class="signup-decoration">
                <div class="shape-1"></div>
                <div class="shape-2"></div>
                <div class="shape-3"></div>
            </div>

            <div class="signup-card">
                <div class="signup-header">
                    <div class="logo-container">
                        <img src="../Resources/images/Beyond Man Logo (Circle).png" alt="Beyond Man Logo"
                            style="height: 5rem;">
                    </div>
                    <h1>Create Your Account</h1>
                    <p>Join us today to start your learning journey</p>
                </div>

                <form class="signup-form" id="signupForm" novalidate>
                    <!-- Name Field -->
                    <div class="form-group">
                        <label for="name">Full Name</label>
                        <div class="input-wrapper" data-validation="name">
                            <i class="fas fa-user"></i>
                            <input type="text" id="name" name="name" placeholder="Enter your full name"
                                autocomplete="name" required>
                            <div class="validation-icons">
                                <i class="fas fa-check-circle valid-icon"></i>
                                <i class="fas fa-exclamation-circle invalid-icon"></i>
                            </div>
                        </div>
                        <div class="validation-feedback">
                            <div class="hint-text">3-40 characters, letters and spaces only</div>
                            <div class="error-message"></div>
                        </div>
                    </div>

                    <!-- Username Field -->
                    <div class="form-group">
                        <label for="username">Username</label>
                        <div class="input-wrapper" data-validation="username">
                            <i class="fas fa-at"></i>
                            <input type="text" id="username" name="username" placeholder="Choose a username"
                                autocomplete="username" required>
                            <div class="validation-icons">
                                <i class="fas fa-check-circle valid-icon"></i>
                                <i class="fas fa-exclamation-circle invalid-icon"></i>
                            </div>
                        </div>
                        <div class="validation-feedback">
                            <div class="hint-text">3-40 characters, lowercase letters, numbers, ._-@</div>
                            <div class="error-message"></div>
                        </div>
                    </div>

                    <!-- Email Field -->
                    <div class="form-group">
                        <label for="email">Email</label>
                        <div class="input-wrapper" data-validation="email">
                            <i class="fas fa-envelope"></i>
                            <input type="email" id="email" name="email" placeholder="Enter your email"
                                autocomplete="email" required>
                            <div class="validation-icons">
                                <i class="fas fa-check-circle valid-icon"></i>
                                <i class="fas fa-exclamation-circle invalid-icon"></i>
                            </div>
                        </div>
                        <div class="validation-feedback">
                            <div class="hint-text">Enter a valid email address</div>
                            <div class="error-message"></div>
                        </div>
                    </div>

                    <!-- Password Field -->
                    <div class="form-group">
                        <label for="password">Password</label>
                        <div class="input-wrapper" data-validation="password">
                            <i class="fas fa-lock"></i>
                            <input type="password" id="password" name="password" placeholder="Create a password"
                                autocomplete="new-password" required>
                            <div class="validation-icons">
                                <i class="fas fa-check-circle valid-icon"></i>
                                <i class="fas fa-exclamation-circle invalid-icon"></i>
                            </div>
                            <button type="button" class="toggle-password" aria-label="Toggle password visibility">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="validation-feedback">
                            <div class="hint-text">8+ chars, uppercase, lowercase, number, special</div>
                            <div class="error-message"></div>
                        </div>
                        <div class="password-strength">
                            <div class="strength-bar"></div>
                            <div class="strength-text"></div>
                        </div>
                    </div>

                    <!-- Terms Checkbox -->
                    <div class="form-checkbox">
                        <input type="checkbox" id="terms" name="terms" value="true">
                        <label for="terms">I agree to the <a href="/terms-and-conditions" target="_blank">Terms of
                                Service</a> and <a href="/privacy-policy" target="_blank">Privacy Policy</a></label>
                        <div class="terms-error error-message"></div>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="signup-btn" id="submit-btn">
                        <span class="btn-text">Create Account</span>
                        <span class="btn-loader" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i>
                        </span>
                        <i class="fas fa-arrow-right btn-icon"></i>
                    </button>

                    <!-- Login Link -->
                    <div class="signup-footer">
                        <p>Already have an account? <a href="/login">Log in</a></p>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Notification System
        class NotificationSystem {
            constructor() {
                this.container = document.getElementById('notificationContainer');
                this.notifications = [];
                this.autoCloseDelay = 5000; // 5 seconds
            }

            show(title, message, type = 'info', duration = 5000) {
                const notification = this.createNotification(title, message, type);
                this.container.appendChild(notification);
                this.notifications.push(notification);

                // Auto remove after duration
                const autoRemove = setTimeout(() => {
                    this.remove(notification);
                }, duration);

                // Add click to close
                const closeBtn = notification.querySelector('.notification-close');
                closeBtn.addEventListener('click', () => {
                    clearTimeout(autoRemove);
                    this.remove(notification);
                });

                return notification;
            }

            createNotification(title, message, type) {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;

                // Set icon based on type
                let icon = 'info-circle';
                switch (type) {
                    case 'success': icon = 'check-circle'; break;
                    case 'error': icon = 'exclamation-circle'; break;
                    case 'warning': icon = 'exclamation-triangle'; break;
                    case 'info': icon = 'info-circle'; break;
                }

                notification.innerHTML = `
            <i class="fas fa-${icon} notification-icon"></i>
            <div class="notification-content">
                <div class="notification-title">${title}</div>
                <div class="notification-message">${message}</div>
            </div>
            <button class="notification-close" aria-label="Close notification">
                <i class="fas fa-times"></i>
            </button>
        `;

                return notification;
            }

            remove(notification) {
                if (!notification.parentNode) return;

                notification.classList.add('fade-out');

                setTimeout(() => {
                    if (notification.parentNode) {
                        this.container.removeChild(notification);
                    }
                    const index = this.notifications.indexOf(notification);
                    if (index > -1) {
                        this.notifications.splice(index, 1);
                    }
                }, 300);
            }

            clearAll() {
                this.notifications.forEach(notification => {
                    this.remove(notification);
                });
            }
        }


        // Initialize notification system
        const Notifications = new NotificationSystem();

        (function () {
            'use strict';

            // Configuration
            const CONFIG = {
                apiEndpoint: '/register',
                validation: {
                    name: {
                        pattern: /^[a-zA-Z\s]+$/,
                        minLength: 3,
                        maxLength: 40,
                        errorMessage: 'Only letters and spaces allowed',
                        requiredMessage: 'Full name is required'
                    },
                    username: {
                        pattern: /^[a-z0-9._@-]+$/,
                        minLength: 3,
                        maxLength: 40,
                        errorMessage: 'Only lowercase letters, numbers, and . _ - @',
                        requiredMessage: 'Username is required'
                    },
                    email: {
                        pattern: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
                        minLength: 1,
                        maxLength: 100,
                        errorMessage: 'Please enter a valid email address',
                        requiredMessage: 'Email is required'
                    },
                    password: {
                        pattern: /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_\-+=<>?]).+$/,
                        minLength: 8,
                        maxLength: 50,
                        errorMessage: 'Must include uppercase, lowercase, number, and special character',
                        requiredMessage: 'Password is required'
                    }
                },
                passwordStrength: {
                    thresholds: { weak: 2, medium: 4, strong: 6 },
                    labels: {
                        weak: 'Weak password',
                        medium: 'Medium password',
                        strong: 'Strong password',
                        veryStrong: 'Very strong password'
                    }
                }
            };

            // DOM Elements
            const elements = {
                form: document.getElementById('signupForm'),
                name: document.getElementById('name'),
                username: document.getElementById('username'),
                email: document.getElementById('email'),
                password: document.getElementById('password'),
                terms: document.getElementById('terms'),
                togglePasswordBtn: document.querySelector('.toggle-password'),
                submitBtn: document.getElementById('submit-btn'),
                strengthBar: document.querySelector('.strength-bar'),
                strengthText: document.querySelector('.strength-text')
            };

            // Validate that required elements exist
            if (!elements.form || !elements.name || !elements.username ||
                !elements.email || !elements.password || !elements.terms) {
                console.error('Required form elements not found');
                return;
            }

            // Validation Functions
            const Validator = {
                validateField(field, config) {
                    const wrapper = field?.closest('.input-wrapper');
                    const formGroup = field?.closest('.form-group');

                    if (!wrapper || !formGroup) return false;

                    const value = field.value.trim();
                    const errorElement = formGroup.querySelector('.error-message');

                    // Reset validation state
                    wrapper.classList.remove('valid', 'invalid');
                    formGroup.classList.remove('has-error');

                    // Empty field validation
                    if (value.length === 0) {
                        this.showError(wrapper, formGroup, errorElement, config.requiredMessage);
                        return false;
                    }

                    // Length validation
                    if (value.length < config.minLength) {
                        this.showError(wrapper, formGroup, errorElement,
                            `Must be at least ${config.minLength} characters`);
                        return false;
                    }

                    if (value.length > config.maxLength) {
                        this.showError(wrapper, formGroup, errorElement,
                            `Must not exceed ${config.maxLength} characters`);
                        return false;
                    }

                    // Pattern validation
                    if (config.pattern && !config.pattern.test(value)) {
                        this.showError(wrapper, formGroup, errorElement, config.errorMessage);
                        return false;
                    }

                    // Valid state
                    wrapper.classList.add('valid');
                    if (errorElement) errorElement.textContent = '';
                    return true;
                },

                showError(wrapper, formGroup, errorElement, message) {
                    wrapper.classList.add('invalid');
                    formGroup.classList.add('has-error');
                    if (errorElement) errorElement.textContent = message;
                },

                validateTerms() {
                    const termsGroup = elements.terms.closest('.form-checkbox');
                    const termsError = termsGroup.querySelector('.terms-error');

                    termsGroup.classList.remove('invalid', 'has-error');

                    if (!elements.terms.checked) {
                        termsError.textContent = 'You must accept the terms and conditions';
                        termsGroup.classList.add('invalid', 'has-error');
                        return false;
                    }

                    termsError.textContent = '';
                    return true;
                },

                checkPasswordStrength(password) {
                    if (!elements.strengthBar || !elements.strengthText) return;

                    elements.strengthBar.className = 'strength-bar';

                    if (password.length === 0) {
                        elements.strengthBar.style.width = '0';
                        elements.strengthText.textContent = '';
                        return;
                    }

                    let strength = 0;
                    const checks = [
                        password.length >= 8,
                        password.length >= 12,
                        /[A-Z]/.test(password),
                        /[a-z]/.test(password),
                        /[0-9]/.test(password),
                        /[^A-Za-z0-9]/.test(password)
                    ];

                    strength = checks.filter(Boolean).length;
                    if (checks[5]) strength++; // Bonus for special chars

                    const { thresholds, labels } = CONFIG.passwordStrength;

                    if (strength <= thresholds.weak) {
                        elements.strengthBar.classList.add('strength-weak');
                        elements.strengthText.textContent = labels.weak;
                    } else if (strength <= thresholds.medium) {
                        elements.strengthBar.classList.add('strength-medium');
                        elements.strengthText.textContent = labels.medium;
                    } else if (strength <= thresholds.strong) {
                        elements.strengthBar.classList.add('strength-strong');
                        elements.strengthText.textContent = labels.strong;
                    } else {
                        elements.strengthBar.classList.add('strength-very-strong');
                        elements.strengthText.textContent = labels.veryStrong;
                    }
                }
            };

            // UI Controller
            const UI = {
                setLoadingState(isLoading) {
                    const btnText = elements.submitBtn.querySelector('.btn-text');
                    const btnLoader = elements.submitBtn.querySelector('.btn-loader');
                    const btnIcon = elements.submitBtn.querySelector('.btn-icon');

                    elements.submitBtn.disabled = isLoading;

                    if (btnText) btnText.style.display = isLoading ? 'none' : 'inline';
                    if (btnLoader) btnLoader.style.display = isLoading ? 'inline' : 'none';
                    if (btnIcon) btnIcon.style.display = isLoading ? 'none' : 'inline';
                },

                shakeErrorFields() {
                    const errorGroups = document.querySelectorAll('.has-error');
                    errorGroups.forEach(group => {
                        group.classList.add('shake');
                        setTimeout(() => group.classList.remove('shake'), 500);
                    });
                },

                showNotification(message, type = 'info') {
                    const titles = {
                        success: 'Success!',
                        error: 'Error!',
                        warning: 'Warning!',
                        info: 'Info'
                    };

                    Notifications.show(titles[type] || titles.info, message, type);
                },


                showHintsForEmptyFields() {
                    [elements.name, elements.username, elements.email, elements.password].forEach(field => {
                        if (!field.value.trim()) {
                            const hint = field.closest('.form-group')?.querySelector('.hint-text');
                            if (hint) hint.style.display = 'block';
                        }
                    });
                }
            };

            // API Handler
            const API = {
                async signup(userData) {
                    try {
                        const response = await fetch(CONFIG.apiEndpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(userData)
                        });

                        const data = await response.json();

                        if (!response.ok) {
                            throw new Error(data.message);
                        }

                        return { success: true, message: data.message };
                    } catch (error) {

                        return { success: false, message: error.message };
                    }
                }
            };

            // Event Handlers
            const EventHandlers = {
                handleNameInput() {
                    Validator.validateField(elements.name, CONFIG.validation.name);
                },

                handleUsernameInput() {
                    Validator.validateField(elements.username, CONFIG.validation.username);
                },

                handleEmailInput() {
                    Validator.validateField(elements.email, CONFIG.validation.email);
                },

                handlePasswordInput() {
                    Validator.validateField(elements.password, CONFIG.validation.password);
                    Validator.checkPasswordStrength(elements.password.value);
                },

                handleTermsChange() {
                    Validator.validateTerms();
                },

                handleInputFocus(e) {
                    const wrapper = e.target.closest('.input-wrapper');
                    const formGroup = e.target.closest('.form-group');

                    if (wrapper) wrapper.classList.add('focused');

                    const hint = formGroup?.querySelector('.hint-text');
                    if (hint) hint.style.display = 'block';
                },

                handleInputBlur(e) {
                    const wrapper = e.target.closest('.input-wrapper');
                    if (wrapper) wrapper.classList.remove('focused');

                    if (e.target === elements.name) {
                        Validator.validateField(elements.name, CONFIG.validation.name);
                    } else if (e.target === elements.username) {
                        Validator.validateField(elements.username, CONFIG.validation.username);
                    } else if (e.target === elements.email) {
                        Validator.validateField(elements.email, CONFIG.validation.email);
                    } else if (e.target === elements.password) {
                        Validator.validateField(elements.password, CONFIG.validation.password);
                    }
                },

                togglePasswordVisibility() {
                    const isPassword = elements.password.type === 'password';
                    elements.password.type = isPassword ? 'text' : 'password';

                    const icon = elements.togglePasswordBtn.querySelector('i');
                    icon.classList.toggle('fa-eye', !isPassword);
                    icon.classList.toggle('fa-eye-slash', isPassword);
                },

                async handleSubmit(e) {
                    e.preventDefault();

                    // Validate all fields
                    const isNameValid = Validator.validateField(elements.name, CONFIG.validation.name);
                    const isUsernameValid = Validator.validateField(elements.username, CONFIG.validation.username);
                    const isEmailValid = Validator.validateField(elements.email, CONFIG.validation.email);
                    const isPasswordValid = Validator.validateField(elements.password, CONFIG.validation.password);
                    const isTermsValid = Validator.validateTerms();

                    if (!isNameValid || !isUsernameValid || !isEmailValid || !isPasswordValid || !isTermsValid) {
                        UI.shakeErrorFields();
                        UI.showHintsForEmptyFields();
                        return;
                    }

                    // Show loading state
                    UI.setLoadingState(true);

                    // Prepare user data
                    const userData = {
                        name: elements.name.value.trim(),
                        username: elements.username.value.trim(),
                        email: elements.email.value.trim(),
                        password: elements.password.value,
                        terms: elements.terms.checked
                    };

                    // Submit to API
                    const result = await API.signup(userData);

                    UI.setLoadingState(false);

                    if (result.success) {
                        UI.showNotification(result.message || 'Account created successfully! Please check your email for verification.', 'success');

                        // Redirect to email verification page or login
                        setTimeout(() => {
                            window.location.href = `/verify-otp?email=${encodeURIComponent(userData.email)}`;
                        }, 5000);
                    } else {
                        UI.showNotification(result.message || 'Signup failed. Please try again.', 'error');

                        // Clear password on error
                        elements.password.value = '';
                        Validator.checkPasswordStrength('');
                    }
                }
            };

            // Initialize Event Listeners
            function initEventListeners() {
                // Input validation
                elements.name.addEventListener('input', EventHandlers.handleNameInput);
                elements.username.addEventListener('input', EventHandlers.handleUsernameInput);
                elements.email.addEventListener('input', EventHandlers.handleEmailInput);
                elements.password.addEventListener('input', EventHandlers.handlePasswordInput);
                elements.terms.addEventListener('change', EventHandlers.handleTermsChange);

                // Focus/Blur events
                const inputs = document.querySelectorAll('.input-wrapper input');
                inputs.forEach(input => {
                    input.addEventListener('focus', EventHandlers.handleInputFocus);
                    input.addEventListener('blur', EventHandlers.handleInputBlur);
                });

                // Password visibility toggle
                if (elements.togglePasswordBtn) {
                    elements.togglePasswordBtn.addEventListener('click', EventHandlers.togglePasswordVisibility);
                }

                // Form submission
                elements.form.addEventListener('submit', EventHandlers.handleSubmit);
            }

            // Initialize
            initEventListeners();
        })();
    </script>

    <style>
        /* Notification System Styles */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 350px;
        }

        .notification {
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
            transform: translateX(0);
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 1;
            backdrop-filter: blur(10px);
        }

        .notification.fade-out {
            transform: translateX(100%);
            opacity: 0;
        }

        .notification.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-left: 4px solid #047857;
        }

        .notification.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border-left: 4px solid #b91c1c;
        }

        .notification.info {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border-left: 4px solid #1e40af;
        }

        .notification.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border-left: 4px solid #b45309;
        }

        .notification-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .notification-message {
            font-size: 13px;
            opacity: 0.9;
            line-height: 1.4;
        }

        .notification-close {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            padding: 4px;
            font-size: 14px;
            transition: color 0.2s;
            flex-shrink: 0;
        }

        .notification-close:hover {
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .notification-container {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }

            .notification {
                width: 100%;
            }
        }
    </style>